<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Pelacakan</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; }
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // --- GANTI BAGIAN INI DENGAN CONFIG YANG SAMA DENGAN TRACKER ---
        const firebaseConfig = {
            apiKey: "AIzaSyD...",
            authDomain: "project-id.firebaseapp.com",
            databaseURL: "https://project-id-default-rtdb.firebaseio.com",
            projectId: "project-id",
            storageBucket: "project-id.appspot.com",
            messagingSenderId: "123456...",
            appId: "1:123456..."
        };
        // -----------------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Inisialisasi Peta
        var map = L.map('map').setView([-2.5, 118], 5); // Default view Indonesia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let markers = {};

        // Mendengarkan perubahan data di Firebase secara Realtime
        db.ref("devices").on("value", (snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const info = data[key];
                    const lat = info.lat;
                    const lng = info.lng;
                    const timestamp = new Date(info.lastUpdate).toLocaleTimeString();

                    // Jika marker untuk perangkat ini sudah ada, update posisinya
                    if (markers[key]) {
                        markers[key].setLatLng([lat, lng])
                                    .bindPopup(`<b>${key}</b><br>Update: ${timestamp}`)
                                    .openPopup();
                    } else {
                        // Jika belum ada, buat marker baru
                        markers[key] = L.marker([lat, lng]).addTo(map)
                                    .bindPopup(`<b>${key}</b><br>Update: ${timestamp}`)
                                    .openPopup();
                    }
                });
            }
        });
    </script>
</body>
</html>
